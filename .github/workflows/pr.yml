# Simple workflow for deploying static content to GitHub Pages
name: Deploy PR for QA

on:
  # Runs on pushes to PR (including new commits)
  pull_request:
  # Allows you to run this workflow manually from the Actions tab
  # Provides an input for PR number when running manually (to handle cases where no PR context exists)
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number (required for manual runs to specify subfolder)'
        required: true
        type: string

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # Define PR number: Use event.number for PRs, or input for manual runs
      - name: Set PR number
        id: pr_info
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.number }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            echo "Unsupported trigger: ${{ github.event_name }}"
            exit 1
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          if [ -z "$PR_NUMBER" ]; then
            echo "PR number is required but not set."
            exit 1
          fi
      
      # Create a deploy directory and copy static files into a PR-specific subfolder
      # This structures the artifact so Pages serves it at /pr-{PR_NUMBER}/
      - name: Prepare deploy directory with PR subfolder
        run: |
          mkdir -p deploy/pr-${PR_NUMBER}
          # Copy all static files (excluding version control and hidden dirs like .git, .github)
          # Adjust this if your static files are in a specific subfolder (e.g., change '.' to 'dist/')
          # Use rsync for better exclusion control (install if needed, but it's usually available)
          rsync -av --exclude='.git' --exclude='.github' --exclude='.gitignore' --exclude='node_modules' --exclude='*.md' --exclude='*.yml' . deploy/pr-${PR_NUMBER}/
          # Alternative simple cp if rsync isn't preferred: cp -r . deploy/pr-${PR_NUMBER}/ 2>/dev/null || true
          # Then manually remove unwanted dirs: rm -rf deploy/pr-${PR_NUMBER}/.git deploy/pr-${PR_NUMBER}/.github deploy/pr-${PR_NUMBER}/node_modules
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      # Upload the deploy directory (which includes the PR subfolder)
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'deploy'  # Now uploads with the subfolder structure
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
